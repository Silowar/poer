<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/style_progress.css"/>
		<link rel="stylesheet" href="../css/ui-box.css">
		<link rel="stylesheet" href="../css/gateway_main.css">
		<link rel="stylesheet" href="../css/ui-color.css">
		<link rel="stylesheet" href="../css/new_gateway.css">
	</head>

	<body style="background-color: #FFFFFF;">
		<header class="mui-bar mui-bar-nav fox_header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left fox-white"></a>
			<h1 class="mui-title fox-white" id="label_add_gateway"></h1>
		</header>
		<div class="fox_content">
			<div style="padding: 0px 10px; background-color: #EDEDED;">
				<div style="padding: 0px 10px;">
					<div class="ub ub-ver uinn-FS2">
		                <div class="ub">
		                    <div class="ub ub-ver ub-f1">
		                        <div class="ub-f1 ub ub-ac">
		                            <div class="uwh-FS1 c-gra-FS1 uc-a-FS1 ub ub-ac ub-pc">
		                                <div class="uwh-FS2 sc-bg-alert uc-a-FS2 ub ub-ac ub-pc">
		                                    <div class="ub-img uwh-FS3 formStep1"></div>
		                                </div>
		                            </div>
		                            <div class="ub-f1 uh-FS1 c-gra-FS1"></div>
		                        </div>
		                        <div class="ulev-2 umar-tFS1">
		                            <span id="label_scan"></span><br/><span id="label_deviceid"></span>
		                        </div>
		                    </div>
		                    <div class="ub ub-ver ub-f1">
		                        <div class="ub-f1 ub ub-ac">
		                            <div class="uwh-FS1 c-gra-FS1 uc-a-FS1 ub ub-ac ub-pc">
		                                <div id="s2_flag" class="uwh-FS2 c-gra-FS2 uc-a-FS2 ub ub-ac ub-pc">
		                                    <div class="ub-img uwh-FS3 formStep2"></div>
		                                </div>
		                            </div>
		                            <div class="ub-f1 uh-FS1 c-gra-FS1"></div>
		                        </div>
		                        <div class="ulev-2 umar-tFS1">
		                            <span id="label_connect"></span><br/><span id="label_gateway"></span>
		                        </div>
		                    </div>
		                    <div class="ub ub-ver ub-f1">
		                        <div class="ub-f1 ub ub-ac">
		                            <div class="uwh-FS1 c-gra-FS1 uc-a-FS1 ub ub-ac ub-pc">
		                                <div  id="s3_flag" class="uwh-FS2 c-gra-FS2  uc-a-FS2 ub ub-ac ub-pc">
		                                    <div class="ub-img uwh-FS3 formStep3"></div>
		                                </div>
		                            </div>
		                            <div class="ub-f1 uh-FS1 c-gra-FS1"></div>
		                        </div>
		                        <div class="ulev-2 umar-tFS1">
		                            <span id="label_register"></span><br/><span id="label_gateway2"></span>
		                        </div>
		                    </div>
		                    <div class="ub ub-ver">
		                        <div class="ub">
		                            <div class="uwh-FS1 c-gra-FS1 uc-a-FS1 ub ub-ac ub-pc">
		                                <div  id="s4_flag" class="uwh-FS2 c-gra-FS2 uc-a-FS2 ub ub-ac ub-pc">
		                                    <div class="ub-img uwh-FS3 formStep4"></div>
		                                </div>
		                            </div>
		                        </div>
		                        <div class="ulev-2 umar-tFS1 tx-c">
		                            <span id="label_check"></span><br/><span id="label_status"></span>
		                        </div>
		                    </div>
		                </div>
		            </div>
				</div>
			</div>
			<div>
				<div id="s1" class="mui-control-content mui-active" style="background-color:#ffffff;">
					<div style="padding:20px 20px 0px 20px;" id="label_gateway_tip_one">
					</div>
					<div>
						<center>
							<img src="../img/lan_addgateway1.png" style="height:160px;width:200px;" />
						</center>
					</div>
					<div style="width:85%;margin:0 auto;">
						<button id="scan" type="button" class="fox_btn_green"><font color="#ffffff" size="4" id="scan_text"></font></button>
					</div>
					<div style="width:85%;margin:0 auto;">
						<div class="fox-input-mac" style="margin: 10px 0px 10px 0px;">
							<input id='mac' type="text" placeholder="" style="padding-left:20px;background-color:transparent;">
						</div>
					</div>
					<div style="width:85%;margin:0 auto;">
						<button id="step1" type="button" class="fox_btn_blue"><font color="#ffffff" size="4" id="step1_text"></font></button>
					</div>
				</div>
				<div id="s2" class="mui-control-content" style="background-color:#ffffff;">
                    <div style="padding:20px 20px 0px 20px;" id="label_gateway_tip_two_top">
                    </div>
                    <!--<div style="padding:10px 20px 0px 20px;" id="label_gateway_tip_two_middle">
                    </div>-->
                    <div style="padding:10px 20px 20px 20px;" id="label_gateway_tip_two_bottom">
                    </div>
					<div style="width:85%;margin:0 auto;">
						<button id="go_connect" type="button" class="fox_btn_green"><font color="#ffffff" size="4" id="go_connect_text"></font></button>
					</div>
	                <div style="padding:20px 0px 15px 30px;color:#5CACEE;" id="label_connected_ap">
                    </div>
                    <div style="width:85%;margin:0 auto;">
						<button id="step2" type="button" class="fox_btn_blue"><font color="#ffffff" size="4" id="step2_text"></font></button>
					</div>
				</div>
				<div id="s3" class="mui-control-content" style="background-color:#ffffff;">
					<div style="padding:20px 20px 20px 20px;" id="label_gateway_tip_three">
                    </div>
					<div style="width:85%;margin:0 auto;">
						<div class="fox-input-wifi">
							<input id='wifi' type="text" placeholder="" style="padding-left:50px;background-color:transparent;">
						</div>
					</div>
					<div style="width:85%;margin:0 auto;">
						<div class="fox-input-password">
							<input id='password' type="password" placeholder="" style="padding-left:50px;background-color:transparent;">
						</div>
					</div>
					<div style="width:85%;margin:0 auto;">
						<button id="step3" type="button" class="fox_btn_blue"><font color="#ffffff" size="4" id="step3_text"></font></button>
					</div>
				</div>
				<div id="s4" class="mui-control-content" style="background-color:#ffffff;">
					<div style="padding:20px 0px 0px 20px;" id="label_gateway_tip_four">
                    </div>
                    <div style="width:85%;margin:0 auto;padding-top:20px;">
						<button id="go_connect_again" type="button" class="fox_btn_green"><font color="#ffffff" size="4" id="go_connect_again_text"></font></button>
					</div>
	                <div style="width:85%;margin:0 auto;padding-top:20px;">
						<button id="step4" type="button" class="fox_btn_green"><font color="#ffffff" size="4" id="check_gateway_connection_text"></font></button>
					</div>
					<div style="width:85%;margin:0 auto;padding-top:20px;">
						<button id="add_device" type="button" class="fox_btn_blue" style="display: none;"><font color="#ffffff" size="4" id="add_device_text"></font></button>
					</div>
				</div>
			</div>
		</div>
		<div id="progressPopover" class="mui-popover">
			<div class="loading-bar">
				<div class="amount green" style="width: 1%;" id="poer_progress_div">
				</div>
				<div>
					<center id="check"></center>
				</div>
			</div>
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/logger.js"></script>
		<script src="../js/wifi.js"></script>
		<script src="../js/function.js"></script>
		<script src="../js/url.js"></script>
		<script src="../js/public.js"></script>
		<script src="../js/language.js"></script>
		<script src="../js/time_zone.js"></script>
		<script>
			var language;
			function show_label(){
				document.getElementById("label_add_gateway").innerHTML = poer_language.label_add_gateway(language);
				document.getElementById("label_scan").innerHTML = poer_language.label_scan(language);
				document.getElementById("label_deviceid").innerHTML = poer_language.label_deviceid(language);
				document.getElementById("mac").placeholder = poer_language.label_type_id_manually(language);
				document.getElementById("label_connect").innerHTML = poer_language.label_connect(language);
				document.getElementById("label_gateway").innerHTML = poer_language.label_gateway(language);
				document.getElementById("label_register").innerHTML = poer_language.label_register(language); 
				document.getElementById("label_gateway2").innerHTML = poer_language.label_gateway(language);
				document.getElementById("label_check").innerHTML = poer_language.label_check(language);
				document.getElementById("label_status").innerHTML = poer_language.label_status(language);
				
				document.getElementById("label_gateway_tip_one").innerHTML = poer_language.label_gateway_tip_one(language);
				document.getElementById("scan_text").innerHTML = poer_language.label_scan(language);
				document.getElementById("step1_text").innerHTML = poer_language.label_next_step(language);
				
				document.getElementById("label_gateway_tip_two_top").innerHTML = poer_language.label_gateway_tip_two_top(language);
				//document.getElementById("label_gateway_tip_two_middle").innerHTML = poer_language.label_gateway_tip_two_middle(language);
				document.getElementById("label_gateway_tip_two_bottom").innerHTML = poer_language.label_gateway_tip_two_bottom(language);
				document.getElementById("step2_text").innerHTML = poer_language.label_next_step(language);
				document.getElementById("label_connected_ap").innerHTML = poer_language.label_connected_ap(language);
				
				document.getElementById("label_gateway_tip_three").innerHTML = poer_language.label_gateway_tip_three(language);
				document.getElementById("step3_text").innerHTML = poer_language.label_step3(language);
				
				document.getElementById("label_gateway_tip_four").innerHTML = poer_language.label_gateway_tip_four(language);
				document.getElementById("go_connect_again_text").innerHTML = poer_language.label_connect_network(language);
				document.getElementById("check_gateway_connection_text").innerHTML = poer_language.label_check_gateway(language);
				//document.getElementById("step4").innerHTML = poer_language.label_check(language);
				document.getElementById("add_device_text").innerHTML = poer_language.label_add_device(language);
				
				document.getElementById("check").innerHTML = poer_language.label_check_device(language);
			}
			(function($, doc) {
				$.init({
					statusBarBackground: '#f7f7f7'
				});
				$.plusReady(function() {
					plus.screen.lockOrientation("portrait-primary");
					var settings_login_info = poer_function.getLocalStorage("login_info");
					language = settings_login_info.language;
					show_label();
					var settings_user_info = poer_function.getLocalStorage("user_info");
					var userId = settings_user_info.Id; 
					var locateId = poer_function.getLocalStorage("cur_locate_id");
					var set_wifi_value = poer_function.getLocalStorage("wifi_value");
					var set_password_value = poer_function.getLocalStorage("wifi_password");
					
					if(JSON.stringify(set_wifi_value) != "{}"){
						doc.getElementById("wifi").value = set_wifi_value;
						doc.getElementById("password").value = set_password_value;
					}
					
					var macBox = doc.getElementById("mac");
					poer_function.setLocalStorage("scan_code","");
					var ssid;
					
					//macBox.value = "FCE892A9A906";
					
					doc.getElementById("scan").addEventListener('tap', function(event) {
						poer_function.setLocalStorage("scan_from", "add_gateway");
						poer_public.openWindow("barcode_scan.html", "barcode_scan");
					});
					
					window.addEventListener('findMac',function(event){
						//获得事件参数
						var result = event.detail.mac;
						macBox.value = result;
					});
					 
					doc.getElementById('step1').addEventListener('tap', function(event) {
						var mac_value = macBox.value.trim().toUpperCase();
						if(mac_value.length!=12){
							poer_public.alert(poer_language.label_mac_short(language));
			    			return;
						}
						var pre_mac = mac_value.substring(0,6).toUpperCase();
						//判断mac是否合法
			    		if(pre_mac!="FCE892"){
			    			poer_public.alert(poer_language.label_mac_error(language));
			    			return;
			    		}
						ssid = "POR_"+mac_value.substring(6);
						document.getElementById("go_connect_text").innerHTML = poer_language.label_connect(language)+" wifi "+ssid;
						//doc.getElementById("ap_wifi").value = ssid;
						
						doc.getElementById("s1").className = "mui-control-content";
						doc.getElementById("s2").className = "mui-control-content mui-active";
						doc.getElementById("s2_flag").className = "uwh-FS2 uc-a-FS2 ub ub-ac ub-pc sc-bg-alert";
					});
					
					doc.getElementById('go_connect').addEventListener('tap', function(event) {
						if(mui.os.ios){
							var UIApplication = plus.ios.import("UIApplication");
							var NSURL = plus.ios.import("NSURL");
							var setting = NSURL.URLWithString("app-settings:");
							var application = UIApplication.sharedApplication();
							application.openURL(setting);
							plus.ios.deleteObject(setting);
							plus.ios.deleteObject(application);
						}
						else{
							// 连接网关
//							var toast = poer_public.showWaiting(poer_language.label_connect_ap_msg(language),{back:"none"});
//							plus.wifi.connectToWifi(ssid, "", function(result) {
//								toast.close();
//								if (result.status == 1) {
//									poer_public.toast(poer_language.label_connection_success(language));
//								} else {
//									poer_public.toast(poer_language.label_connect_timeout(language));
//								}
//							}, function(result) {
//								poer_public.toast(poer_language.label_connect_timeout(language));
//							})
							var main = plus.android.runtimeMainActivity();
							var Intent = plus.android.importClass("android.content.Intent");
							var mIntent = new Intent('android.settings.WIFI_SETTINGS');
							main.startActivity(mIntent);	
						}
					});
					
					function link_ap_success(data){
						var result = data['Request']["mac"].toUpperCase();
						var wifi = ssid;//doc.getElementById("ap_wifi").value;
						if(result.substring(6)!=wifi.substring(4)){
							poer_public.alert(poer_language.label_link_wrong_ap(language)+wifi);
							return;
						}
						
						doc.getElementById("s2").className = "mui-control-content";
						doc.getElementById("s3").className = "mui-control-content mui-active";
						
						doc.getElementById("s3_flag").className = "uwh-FS2 uc-a-FS2 ub ub-ac ub-pc sc-bg-alert";
					}
					
					function link_ap_fail(xhr,textStatus,errorThrown){
						poer_public.alert(poer_language.label_link_ap_failed(language)+" "+ssid);
					}
					
					doc.getElementById("step2").addEventListener('tap', function(event) {
						//判断有没有连接ap
						var url = poer_url.link_ap_status();
						poer_function.link_ap_status(url, {}, link_ap_success, link_ap_fail);
					});
					
					function link_ap2_success(data){
						poer_public.progress_stop();
						var result = data['Request']["status"];
						//result = "3";
						switch(result){
							case 1:
							case 2: 
								poer_public.alert(poer_language.label_linkwifi_error2(language));
								break;
								
							case 3: 
								poer_public.alert(poer_language.label_linkwifi_error3(language));
								doc.getElementById("s3").className = "mui-control-content";
								doc.getElementById("s4").className = "mui-control-content mui-active";
								doc.getElementById("s4_flag").className = "uwh-FS2 uc-a-FS2 ub ub-ac ub-pc sc-bg-alert";		
								break;
								
							case 4: 
								poer_public.alert(poer_language.label_linkwifi_error4(language));
								break;
								
							case 6: 
								poer_public.alert(poer_language.label_linkwifi_error6(language));
								break;
						}
					}
					
					function link_ap2_fail(xhr,textStatus,errorThrown){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_sendwifi_failed(language));
					}
					
					function link_success(data){
						//发送之后，查询网关联网状态
						var url = poer_url.link_ap_status();
						
						setTimeout(function(){
							poer_function.link_ap_status(url, {}, link_ap2_success, link_ap2_fail);
						},7000);
					}
					
					function link_fail(xhr,textStatus,errorThrown){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_sendwifi_failed(language));
					}
					
					doc.getElementById("step3").addEventListener('tap', function(event) {
						var wifi = doc.getElementById("wifi").value.trim();
						var password = doc.getElementById("password").value.trim();
						//wifi = "LL";
						//password = "lanlian@702";
						poer_function.setLocalStorage("wifi_value", wifi);
						poer_function.setLocalStorage("wifi_password", password);
						
						if(wifi==""){
							poer_public.alert(poer_language.label_wifi_empty(language));
		    				return;
						}
						if(password==""){
							poer_public.alert(poer_language.label_password_empty(language));
		    				return;
						}
						
						var data = {
							"Request":{
								"ssid": wifi,
								"password": password	
							}
						};
						
						doc.getElementById("check").innerHTML = poer_language.label_check_ap_status(language);
						poer_public.progress_start();
						var url = poer_url.link_gateway();
						poer_function.link_gateway(url, JSON.stringify(data), link_success, link_fail);
						
						/*
						var CMD_SIZE = 1;
						var SSID_SIZE = 32;
						var PASSWD_SIZE = 64;
						var i;
						data[0] = 0x00;
						data = data.concat(Str2Bytes(wifi));
						var length = SSID_SIZE - wifi.length;
						for(i = 0;i<length;i++){
							data.push(0x00);
						}
						data = data.concat(Str2Bytes(password));
						length = PASSWD_SIZE - password.length;
						for(i = 0;i<length;i++){
							data.push(0x00);
						}
						
						if(mui.os.ios){
						}
						else{
							var DatagramPacket = plus.android.importClass("java.net.DatagramPacket");
						    var DatagramSocket = plus.android.importClass("java.net.DatagramSocket");
						    var InetAddress = plus.android.importClass("java.net.InetAddress");
							
						    var ds = new DatagramSocket();
						    var messageReceived = false;
						    //var serverAddress = "192.168.4.1";
						    var port = 2020; // 服务器设定好的监听端口
						    var iAdd = new InetAddress();
						    var dp = new DatagramPacket(data, data.length,iAdd.getByName("255.255.255.255"), port);
						    while (!messageReceived){
						        //var d = new Array(1024);
						        //d = Str2Bytes("http://255.255.255.255:8898"); // 原java代码 byte[] data = new byte[1024]不知道如何改写，就随便写一个足够ip长度的string
						        //var dp2 = new DatagramPacket(d, 1024);
						        ds.send(dp); // 发出udp广播
						        //ds.receive(dp2); //这里要是服务器没开就会卡住了。原java代码是另开一个线程，js是单线程，所以最好写一个10秒后断开再重试的代码。另，已发现HTML5支持多线程的web workers无法初始化plusready。
						        //var dpData = Bytes2Str(dp2.getData()); // 转换数据流为我要的地址
						        messageReceived=true;
						        ds.close();
						        
						        doc.getElementById("s3").className = "mui-control-content";
								doc.getElementById("s4").className = "mui-control-content mui-active";
								doc.getElementById("s4_flag").className = "uwh-FS2 uc-a-FS2 ub ub-ac ub-pc sc-bg-alert";
						    }
						}
						*/
					});
					
					doc.getElementById('go_connect_again').addEventListener('tap', function(event) {
						if(mui.os.ios){
							var UIApplication = plus.ios.import("UIApplication");
							var NSURL = plus.ios.import("NSURL");
							var setting = NSURL.URLWithString("app-settings:");
							var application = UIApplication.sharedApplication();
							application.openURL(setting);
							plus.ios.deleteObject(setting);
							plus.ios.deleteObject(application);
						}
						else{
							// 连接wifi
//							var wifiSSID = doc.getElementById("wifi").value;
//							var wifiPassword = doc.getElementById("password").value;
//							var toast = poer_public.showWaiting(poer_language.label_change_ap_msg(language),{back:"none"});
//							plus.wifi.connectToWifi(wifiSSID, wifiPassword, function(result) {
//								toast.close();
//								if (result.status == 1) {
//									poer_public.toast(poer_language.label_connection_success(language));
//								} else {
//									poer_public.toast(poer_language.label_connect_timeout(language));
//								}
//							}, function(result) {
//								poer_public.toast(poer_language.label_connect_timeout(language));
//							})
							
							
							
							var main = plus.android.runtimeMainActivity();
							var Intent = plus.android.importClass("android.content.Intent");
							var mIntent = new Intent('android.settings.WIFI_SETTINGS');
							main.startActivity(mIntent);	
						}
					});
					
					function update_gateway_success(data){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_bindgateway_success(language));
						add_device_btn.style.display = "";
					}
					
					function update_gateway_fail(xhr,textStatus,errorThrown){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_bindgateway_success(language));
						add_device_btn.style.display = "";
					}
					
					function get_gateway_success(data){
						var d=new Date();
						var offset = d.getTimezoneOffset();
						offset *= -1;
						
						var time_zones = poer_timezone.time_zone();
						var show_time;
						//转换成12:00格式
						show_time = parseInt(offset/60)+":";
						if(offset%60<10){
							show_time += "0"+offset%60;
						}
						else{
							show_time += offset%60;
						}
						show_time = offset<0 ? "-"+show_time : "+"+show_time;
						var zone_city = '';
						for(var i in time_zones){
							if(time_zones[i] == show_time){
								zone_city = i;
								break;
							}
						}
						
						var gateway_id = data.Id;
						var url = poer_url.update_gateway(userId, gateway_id);
						var data = {
							"DstEnable": data['DstEnable'],
							"DstEnd": data['DstEnd'],
							"DstOffset": data['DstOffset'],
							"DstStart": data['DstStart'],
							"ZoneOffset": offset,
							"ZoneCity": zone_city
						};

						poer_function.update_gateway(url, JSON.stringify(data), update_gateway_success, update_gateway_fail);
					}
					
					function get_gateway_fail(xhr,textStatus,errorThrown){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_bindgateway_success(language));
						add_device_btn.style.display = "";
					}
					
					//function test(){
					//	var url = poer_url.gateway_info(userId,'FCE8922DCCBF');
					//	poer_function.get_gateway_info(url, {}, get_gateway_success, get_gateway_fail);
					//}
					//test();
					
					function check_success(data){
						if(data.Flag){
							//设置网关时区
							doc.getElementById("check").innerHTML = poer_language.label_set_timezone(language);
							//poer_public.progress_start();
							var url = poer_url.gateway_info(userId,macBox.value.trim().toUpperCase());
							poer_function.get_gateway_info(url, {}, get_gateway_success, get_gateway_fail);
						}
						else{
							check_count++;
							if(check_count>30){
								poer_public.progress_stop();
								poer_public.alert(poer_language.label_bindgateway_failed(language));
								check_count = 0;
							}
							else{
								setTimeout(check_gateway, 3000);
							}
						}
					}
					
					function check_fail(xhr,textStatus,errorThrown){
						poer_public.progress_stop();
						poer_public.alert(poer_language.label_bindgateway_failed(language));
					}
					
					function check_gateway(){
						var url = poer_url.check_gateway(userId, locateId, ssid);
						poer_function.check_gateway(url, {}, check_success, check_fail);
					}
					
					var check_count = 0;
					
					function get_user_success(data){
						
						document.getElementById("check").innerHTML = poer_language.label_check_gateway(language);
						poer_public.progress_start();
						check_gateway();
					}
					
					function get_user_fail(xhr,textStatus,errorThrown){
						poer_public.alert(poer_language.label_link_wifi_failed(language));
					}
					
					doc.getElementById("step4").addEventListener('tap', function(event) {
						//判断是否切换回来wifi，通过获取user info来判断是否网络正常
						var url = poer_url.get_user_info(userId);
						poer_function.get_user_info(url, {}, get_user_success, get_user_fail);
					});
					
					var add_device_btn = doc.getElementById("add_device");
					doc.getElementById("add_device").addEventListener('tap', function(event) {
						//poer_public.openWindow("add_thermostat.html", "add_thermostat");
						mui.back();
					});
				});
			}(mui, document));
		</script>
	</body>
</html>