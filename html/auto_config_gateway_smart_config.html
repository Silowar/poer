<!DOCTYPE html>
<html class="ui-page-login">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title></title>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <link href="../css/mui.picker.css" rel="stylesheet"/>
    <link href="../css/mui.poppicker.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../css/style_progress.css"/>
    <link rel="stylesheet" href="../css/ui-box.css">
    <link rel="stylesheet" href="../css/gateway_main.css">
    <link rel="stylesheet" href="../css/ui-color.css">
    <link rel="stylesheet" href="../css/new_gateway.css">
    <link rel="stylesheet" href="../css/iconfont.css"/>
    <link rel="stylesheet" href="../css/auto_configuration.css"/>
    <link rel="stylesheet" href="../css/svg_style.css"/>
</head>

<body style="background-color: #FFFFFF;">
<header class="mui-bar mui-bar-nav fox_header">
    <a id="btnBack" class="mui-icon mui-icon-left-nav mui-pull-left fox-white"></a>
    <h1 class="mui-title fox-white" id="label_add_gateway">New Gateway</h1>
    <!--<a id="faqButton" class="mui-pull-right fox-white faq-button">FAQ</a>-->
</header>
<div class="fox_content">
    <div class="step-box">
        <div class="step-item">
            <img id="img-step-1" src="../img/preparationg-on.png"/>
            <img id="step-1" src="../img/step-on.png" class="step-img"/>
            <b id="name-step-1"></b>
        </div>
        <div class="step-item">
            <img id="img-step-2" src="../img/wifi-conn-off.png"/>
            <img id="step-2" src="../img/step-off.png" class="step-img"/>
            <b id="name-step-2"></b>
        </div>
        <div class="step-item">
            <img id="img-step-3" src="../img/conn-check-off.png"/>
            <img id="step-3" src="../img/step-off.png" class="step-img"/>
            <b id="name-step-3"></b>
        </div>
    </div>
    <div class="step-content config-step" id="step-content-1">
        <div class="tip-box">
            <span id="tip_step_1"></span>
        </div>
        <div class="eg-img-box">
            <img src="../img/gateway-led-blinking.png"/>
        </div>
        <div class="button-box">
            <button id="btnJumpToStep2"></button>
        </div>
    </div>
    <div class="step-content config-step" id="step-content-2" style="display: none;">
        <div class="input-wifi-info">
            <div class="ssid-box">
                <input id="txtSSID" type="text" readonly="readonly"/>
            </div>
            <div class="wifi-pswd-box">
                <input id="txtPassword" type="text"/>
            </div>
            <div id="macInputBlock" class="mac-input-box" style="display: none;">
                <input id="txtMacAddress" type="text"  placeholder="Choice Mac Address" value="" readonly="readonly"/>
                <span class="mui-icon mui-icon-camera" id="btnScan" style="display: none;"></span>
            </div>
            <button id="btnStartConfig"></button>
        </div>
    </div>
    <div class="step-content config-step" id="step-content-3" style="display: none;">
        <div class="test-config-box">
            <div id="macAddress" class="mac-box"></div>
            <div class="tip-box">
                <span id="tip_step_3"></span>
            </div>
            <div class="eg-img-box">
                <span id="imgTest"></span>
            </div>
        </div>
    </div>
</div>
<script src="../js/mui.min.js"></script>
<script src="../js/mui.picker.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script src="../js/common.js"></script>
<script src="../js/logger.js"></script>
<script src="../js/wifi.js"></script>
<script src="../js/smart_config.js"></script>
<script src="../js/function.js"></script>
<script src="../js/url.js"></script>
<script src="../js/public.js"></script>
<script src="../js/language.js"></script>
<script src="../js/time_zone.js"></script>
<script src="../js/event_listeners.js"></script>
<script src="../js/circles.js"></script>
<script>
    var language;

    function show_labels() {
        // New
        document.getElementById("tip_step_1").innerHTML = poer_language.tip_preparationg(language);
        document.getElementById("tip_step_3").innerHTML = poer_language.tip_connection_check(language);
        document.getElementById("btnJumpToStep2").innerHTML = poer_language.label_next_step(language);
        document.getElementById("btnStartConfig").innerHTML = poer_language.label_next_step(language);
        document.getElementById("txtMacAddress").placeholder = poer_language.choice_mac_address(language);
    }
    (function ($, doc) {
        $.init({
            statusBarBackground: '#f7f7f7'
        });
        $.plusReady(function () {
            plus.screen.lockOrientation("portrait-primary");
            var settings_login_info = poer_function.getLocalStorage("login_info");
            language = settings_login_info.language;
            show_labels();
            //					doc.addEventListener("netchange", netChangeListenner);
            var settings_user_info = poer_function.getLocalStorage("user_info");
            var userId = settings_user_info.Id;
            var locateId = poer_function.getLocalStorage("cur_locate_id");
            var txtSSID = doc.getElementById("txtSSID");
            var txtPassword = doc.getElementById("txtPassword");
            var txtMacAddress = doc.getElementById("txtMacAddress");
            var macAddress = doc.getElementById("macAddress");
            var btnStartConfig = doc.getElementById("btnStartConfig");
            var btnJumpToStep2 = doc.getElementById("btnJumpToStep2");
            var imgTest = doc.getElementById("imgTest");
            var currentStep = 0;
            setStep();
            var waitingToast;
            var currentSSID, gatewaySSID, savedWifiInfo, resultMacAddress,resultInetAddress;
            var check_count = 0;
            var statusCount = 0;
            var dnsCount = 0;
            var apCount = 0;
            var apAgain = 0;
            // SmartConfig 相关参数
            var bSSID;
            var isSsidHidden = false;
            var taskResultCount = 3;
            var stepCount = 5;
            var configTimes = 1;
            var isConfiguring = false;
            var smart_config_times = parseInt(poer_function.getLocalStorage("smart_config_times"));
            var configType = 0;
            var timer = null, timeout = 120, isTimeout = false;
			document.getElementById("label_add_gateway").innerHTML = poer_language.label_add_gateway(language);
//					doc.addEventListener("netchange", function() {
//						if (plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_WIFI) {
//							getCurrentWifiInfo();
//						}
//					});

//          doc.getElementById("faqButton").addEventListener("tap", function (e) {
//              poer_public.openWindow("FAQ.html", "FAQ");
//          });

//          doc.getElementById("btnScan").addEventListener("tap", function (e) {
//              poer_function.setLocalStorage("scan_from", "add_gateway");
//              poer_public.openWindow("barcode_scan.html", "barcode_scan");
//          });

            txtMacAddress.addEventListener("tap", function (e) {
                poer_public.openWindow("wifi_list.html", "wifi_list");
            }, false);

            window.addEventListener('findMac', function (event) {
                //获得事件参数
                var result = event.detail.mac;
                txtMacAddress.value = result;
            });

            function getCurrentWifiInfo() {
                // 获取当前连接的wifi的SSID
                plus.wifi.getCurrentWifiInfo(function (result) {
//                  var waiting = poer_public.showWaiting("Set net info");
                    var wifiInfo = result.resData;
                    currentSSID = wifiInfo.SSID;
                    txtSSID.value = currentSSID;
                    bSSID = wifiInfo.BSSID;
                    if (wifiInfo.hasOwnProperty("HiddenSSID"))
                        isSsidHidden = wifiInfo.HiddenSSID;
                    //获取本地保存的wifi密码
                    savedWifiInfo = poer_function.getLocalStorage("LOCAL_WIFIINFO_" + currentSSID);
                    if (!$.isEmptyObject(savedWifiInfo))
                        txtPassword.value = savedWifiInfo.wifiPassword;

//                  waiting.close();
                });
            }

            if (isWifiConnected(true)) {
                getCurrentWifiInfo();
            } else {
                $.back();
            }
            var state = false;
            imgTest.addEventListener("tap", function () {
                var reqUrl = poer_url.light_gateway(userId, macAddress.innerHTML.trim());
                poer_function.light_gateway(reqUrl, {}, testGatewaySuccess, testGatewayFail);
            });

            function testGatewaySuccess(result) {
                //						if (result.GetStatus)
                //						if (result.)
                if (result.IsOnline) {
                    if (result.GetStatus) {

                    } else {

                    }
                } else {
                    poer_public.toast(poer_language.label_gateway_test_failed(language));
                }
            }

            function testGatewayFail(xhr, textStatus, errorThrown) {
                //						poer_public.toast()
                poer_public.toast(poer_language.label_gateway_test_failed(language));
            }

            btnJumpToStep2.addEventListener("tap", function (e) {
                currentStep = 1;
                setStep();
            });
            // 第一步：输入wifi密码[wifi密码可为空]
            btnStartConfig.addEventListener("tap", function (e) {
                if (isWifiConnected(true)) {
                    if (settings_login_info.email == "demo@poersmart.com") {
                        poer_public.alert(poer_language.msg_demo_can_not_add(language));
                        return;
                    }
                    if (configType == 1 && isAndroid()) {
                        startApConfig();
                    } else {
                        var buttons = poer_language.array_button_array_yes_or_no(language);
                        mui.confirm(poer_language.msg_configuration_confirm(language), poer_language.title_precautions(language), buttons, function (e) {
                            if (e.index == 1) {
                                var currentWifiInfo = {
                                    SSID: currentSSID,
                                    wifiPassword: txtPassword.value
                                };
                                poer_function.setLocalStorage("LOCAL_WIFIINFO_" + currentSSID, currentWifiInfo);
                                openConfigProgress();
                                if (isTimeout) return;
                                setTimeout(function () {
                                    smart_config_times++;
                                    poer_function.setLocalStorage("smart_config_times", smart_config_times);
                                    startConfig();
//                                    failConfirm();
                                }, 2000);
                            }
                        });
                    }
                }
            });

            function timerTarget() {
                if (timeout < 0 && isConfiguring) {
                    isTimeout = true;
                    stopConfigProgress();
                    poer_public.alert(poer_language.msg_config_timeout(language));
                } else {
                    timeout--;
                }
            }

            function setTimer() {
                isTimeout = false;
                timer = setInterval(timerTarget, 1000);
            }

            function clearTimer() {
                clearInterval(timer);
                timer = null;
                timeout = 120;
            }

            // SmartConfig模式

            function startConfig() {
                var params = {
                    SSID: currentSSID,
                    password: txtPassword.value,
                    bSSID: bSSID,
                    isSsidHidden: isSsidHidden,
                    taskResultCount: taskResultCount
                };
                plus.smartConfig.startConfiguration(params, smartConfigConfigurationSuccess, smartConfigConfigurationFailed);
            }

            /**
             * SmartConfig 配置成功
             * @param {Object} result
             */
            function smartConfigConfigurationSuccess(result) {
                if (isTimeout) return;
                console.log("FUNC--smartConfigConfigurationSuccess" + JSON.stringify(result));
                //						poer_public.toast("result");
                if (result.status == 1) {
                    // 判断是否切换回来wifi，通过获取user info来判断是否网络正常
//                    setTimeout(function () {
                    resultMacAddress = result.mac_address;
                    resultInetAddress = result.InetAddress;
                    
                    macAddress.innerHTML = resultMacAddress.trim().toUpperCase();
                    
                    //调用ip/config?command=status
                    
                		var reqUrl;
                    reqUrl = poer_url.get_gateway_status(resultInetAddress);
                    poer_function.get_gateway_status(reqUrl,{},getGatewayStatusSuccess,getGatewayStatusFailed);
                    
                    gatewaySSID = "POR_" + resultMacAddress.substring(6).toUpperCase();
                    reqUrl = poer_url.get_user_info(userId);
                		poer_function.get_user_info(reqUrl, {}, getUserInfoSuccess, getUserInfoFailed);
//                    }, 2000);
                } 
                
                if(result.status == 0){
                		failConfirm();
                }
//              else {
//                  if (configTimes < 1) {
//                      if (timeout < 0) {
//                          stopConfigProgress();
//                          poer_public.alert(poer_language.msg_config_timeout(language));
//                      } else {
//                          configTimes++;
//                          startConfig();
//                      }
//                  } else {
//                      failConfirm();
//                  }
//              }
            }

            function failConfirm() {
                configTimes = 1;
                stopConfigProgress();
//						var buttons = poer_language.array_buttons_for_smart_config_fail_confirm(language);
//						if (smart_config_times < 2) {
//							buttons.pop();
//						}
                //								poer_public.alert(poer_language.msg_configuration_failed(language));
                /*mui.confirm(poer_language.msg_smart_config_failure(language), poer_language.label_tip(language), buttons, function(e) {
                 switch (e.index) {
                 case 0:
                 currentStep = 0;
                 setStep();
                 getCurrentWifiInfo();
                 break;
                 case 1:
                 // TODO:打开FAQ界面
                 poer_public.openWindow("FAQ.html", "FAQ");
                 break;
                 default:
                 // TODO:打开AP配置界面
                 poer_public.openWindow("auto_config_gateway_ap.html", "add_gateway_ap");
                 break;
                 }
                 });*/


                var buttons = poer_language.array_button_for_sc_config_fail(language);
                var msg = poer_language.msg_sc_config_fail(language);
                mui.confirm(msg, "", buttons, function (e) {
                    switch (e.index) {
                        case 0:
                            if (isAndroid()) {
                                configType = 1;
                                doc.getElementById("macInputBlock").style.display = "table";
                            }
                            break;
                        case 1:
                            currentStep = 0;
                            setStep();
                            getCurrentWifiInfo();
                            break;
                    }
                });
            }

            /**
             * SmartConfig配置失败
             * @param {Object} xhr
             * @param {Object} textStatus
             * @param {Object} errorThrown
             */
            function smartConfigConfigurationFailed(xhr, textStatus, errorThrown) {
            		
                if (isTimeout) return;
                if (configTimes < 1) {
                    if (timeout < 0) {
                        stopConfigProgress();
                        poer_public.alert(poer_language.msg_config_timeout(language));
                    } else {
                        configTimes++;
                        startConfig();
                    }
                } else {
                    failConfirm();
                }
            }

            // AP模式

            function startApConfig() {
                var tempMacAddress = txtMacAddress.value.trim().toUpperCase();
                // 第二步：输入网关Mac地址
                if (tempMacAddress.length != 12) {
                    poer_public.toast(poer_language.label_mac_short(language));
                    return;
                }
                var pre_mac = tempMacAddress.substring(0, 6).toUpperCase();
                if (pre_mac != "FCE892") {
                    poer_public.toast(poer_language.label_mac_error(language));
                    return;
                }
                
                gatewaySSID = "POR_" + tempMacAddress.substring(6);
                macAddress.innerHTML = tempMacAddress;
                resultMacAddress = tempMacAddress;
                openConfigProgress();
                
                if (isTimeout) return;
                var currentWifiInfo = {
                    SSID: currentSSID,
                    wifiPassword: txtPassword.value
                };
                poer_function.setLocalStorage("LOCAL_WIFIINFO_" + currentSSID, currentWifiInfo);
                // a.连接网关
                plus.wifi.connectToWifi(gatewaySSID, "", connectGateWaySuccess, connectGateWayFailed);
            }

            /**
             * 连接网关成功
             * @param {Object} result
             */
            function connectGateWaySuccess(result) {

                if (isTimeout) return;
                if (result.status == 1) {
                    // b.检查网关连接状态
                    var reqUrl = poer_url.link_ap_status();
                    plus.wifi.changeMobileData();
                    setTimeout(function () {
                        poer_function.link_ap_status(reqUrl, {}, checkApConnectStatusSuccess, checkApConnectStatusFailed);
                    }, 5000);
                } else {
                    stopConfigProgress();
                    poer_public.alert(poer_language.msg_gateway_connection_timeout(language));
                    plus.wifi.connectToWifi(txtSSID.value, txtPassword.value);
                }
            }

            /**
             * 连接网关失败
             * @param {Object} result
*/
            function connectGateWayFailed(result) {
                if (isTimeout) return;
                stopConfigProgress();
                poer_public.alert(poer_language.msg_gateway_connection_failed(language));
                plus.wifi.connectToWifi(txtSSID.value, txtPassword.value);
            }

            /**
             * 检查网关连接状态成功
             * @param {Object} result
             */
            function checkApConnectStatusSuccess(result) {
                if (isTimeout) return;
                var resultSSID = result['Request']["mac"].toUpperCase();
                var resultSSID_temp = resultSSID.substring(6).trim().toUpperCase();
                var gatewaySSID_temp = gatewaySSID.substring(4).trim().toUpperCase();
                if( resultSSID_temp != gatewaySSID_temp ){
                		stopConfigProgress();
                    poer_public.alert(poer_language.label_link_wrong_ap(language) + gatewaySSID);
                    return;
                }else{
	                	var wifiPassword = txtPassword.value;
	                var reqData = {
	                    Request: {
	                        ssid: currentSSID,
	                        password: wifiPassword
	                    }
	                }
	                var reqUrl = poer_url.link_gateway();
	                poer_function.link_gateway(reqUrl, JSON.stringify(reqData), connectToRouter, configurationGatewayFailed);
                }
            }

            /**
             * 检查网关连接状态失败
             * @param {Object} result
             */
            function checkApConnectStatusFailed(result) {
                if (isTimeout) return;
                plus.wifi.changeMobileData();
                stopConfigProgress();
                poer_public.alert(poer_language.label_link_wrong_ap(language) + gatewaySSID);
            }

            function checkApStatus() {
                var reqUrl = poer_url.link_ap_status();
                setTimeout(function () {
                    poer_function.link_ap_status(reqUrl, {}, sendWifiSuccess, sendWifiFailed);
                }, 10000);
            }

            /**
             * 网关配置成功
             * @param {Object} result
             */
            function configurationGatewaySuccess(result) {
                if (isTimeout) return;
//                checkApStatus();
                stopConfigProgress();
                poer_public.alert(poer_language.msg_configuration_failed(language));
            }

            /**
             * 网关配置失败
             * @param {Object} result
             */
            function configurationGatewayFailed(result) {
                if (isTimeout) return;
                plus.wifi.changeMobileData();
                stopConfigProgress();
                poer_public.alert(poer_language.label_sendwifi_failed(language));
            }

            /**
             * 网关联网成功
             * @param {Object} result
             */
            function sendWifiSuccess(result) {
                if (isTimeout) return;
                var status = result['Request']["status"];
                plus.wifi.changeMobileData();
                switch (status) {
                    case 1:
                        if (timeout < 0) {
                            stopConfigProgress();
                            poer_public.alert(poer_language.msg_config_timeout(language));
                        } else {
                            checkApStatus();
                        }
                        break;
                    case 2:
                        stopConfigProgress();
                        poer_public.alert(poer_language.label_linkwifi_error2(language));
                        break;
                    case 3:
                        // 成功
                        var wifiPassword = txtPassword.value;
                        plus.wifi.connectToWifi(currentSSID, wifiPassword, connectWifiSuccess, connectWifiFailed);
                        break;
                    case 4:
                        stopConfigProgress();
                        poer_public.alert(poer_language.label_linkwifi_error4(language));
                        break;
                    case 6:
                        stopConfigProgress();
                        poer_public.alert(poer_language.msg_ap_config_failure(language));
                        break;
                }
            }

            /**
             * 网关联网失败
             * @param {Object} result
             */
            function sendWifiFailed(result) {
                if (isTimeout) return;
                //						autoConfigWaitting.close();
                stopConfigProgress();
                poer_public.alert(poer_language.label_sendwifi_failed(language));
            }


            function connectToRouter() {
                if (isTimeout) return;
                
                
                var reqUrl = poer_url.link_ap_status();
                setTimeout(function(){
					poer_function.link_ap_status(reqUrl, {}, checkApConnectStatusTwoSuccess, checkApConnectStatusTwoFailed);
				},2000);
                
            }
            function checkApConnectStatusTwoSuccess(result) {
				switch(result['Request']["status"]){
					case 1:
//						alert("尝试接入");
						if(apCount < 5 ){
							apCount ++;
							setTimeout(function(){
								getLinkApStatusAgain();
							},3000);
						}else{
							stopConfigProgress();
							errstatus(1);
						}
						return;
					case 2:
//						alert("无法从路由器获取动态ip地址");
						stopConfigProgress();
						errstatus(2);
						return;
					case 3:
//						alert("成功接入");
						waitingToast.close();
						waitingToast = poer_public.showWaiting(poer_language.msg_errstatus_3(language));
						break;
					case 4:
//						alert("无线网络配置错误，密码错误");
						stopConfigProgress();
						errstatus(4);
						return;
					case 6:
						if(dnsCount < 3){
							dnsCount ++ ;
							setTimeout(function(){
								getLinkApStatusAgain();
							},3000);
						}else{
//							 alert("dns解析失败");
							 stopConfigProgress();
							 errstatus(6);
						}
						return;
					case 7:
//						alert("网关内部错误，请重新上电");
						stopConfigProgress();
						errstatus(7);
						return;
					default:
						checkApConnectStatusFailed();
						return;
				}
				var wifiPassword = txtPassword.value;
                plus.wifi.connectToWifi(currentSSID, wifiPassword, connectWifiSuccess, connectWifiFailed);
            }
            function checkApConnectStatusTwoFailed(result) {
                if (isTimeout) return;
                if(apAgain < 7){
                		apAgain ++;
                		setTimeout(function(){
                			getLinkApStatusAgain();
                		},2000);
                		
                }
                
            }

            /**
             * 连接wifi成功
             * @param {Object} result
             */
            function connectWifiSuccess(result) {
                if (isTimeout) return;
                //						autoConfigWaitting.close();
                if (result.status == 0) {
                    stopConfigProgress();
                    poer_public.alert(poer_language.msg_wifi_connected_failed(language));
                } else {
                    // 判断是否切换回来wifi，通过获取user info来判断是否网络正常
                    setTimeout(function () {
                        var reqUrl = poer_url.get_user_info(userId);
                        poer_function.get_user_info(reqUrl, {}, getUserInfoSuccess, getUserInfoFailed);
                    }, 1500);
                }
            }

            /**
             * 连接wifi失败
             * @param {Object} result
             */
            function connectWifiFailed(result) {
                if (isTimeout) return;
                //						autoConfigWaitting.close();
                stopConfigProgress();
                poer_public.alert(poer_language.msg_wifi_connected_failed(language));
            }

            // 绑定网关

			
			//获取网关状态成功
			function getGatewayStatusSuccess(data) {
//              if (isTimeout) return;
				console.log("data.Request.status: " + JSON.stringify(data));
				switch(data.Request.status){
					case 1:
//						alert("尝试接入");
						setTimeout(function(){
							getGatewayStatusAgain();
						},3000);
						return;
					case 2:
//						alert("无法从路由器获取动态ip地址");
						stopConfigProgress();
						errstatus(2);
						return;
					case 3:
//						alert("成功接入");
						waitingToast.close();
						waitingToast = poer_public.showWaiting(poer_language.msg_errstatus_3(language));
						break;
					case 4:
//						alert("无线网络配置错误，密码错误");
						stopConfigProgress();
						errstatus(4);
						return;
					case 6:
						if(dnsCount < 3){
							dnsCount ++ ;
							setTimeout(function(){
								getGatewayStatusAgain();
							},3000);
						}else{
//							 alert("dns解析失败");
							 stopConfigProgress();
							 errstatus(6);
						}
						return;
					case 7:
//						alert("网关内部错误，请重新上电");
						stopConfigProgress();
						errstatus(7);
						return;
					default:
						getGatewayStatusFailed();
						return;
				}
            }
			//获取网关状态失败
			function getGatewayStatusFailed(data) {
//              if (isTimeout) return;
				if(statusCount < 5){
					statusCount++;
					setTimeout(function(){
						getGatewayStatusAgain();
					},3000);
				}
            }
			//再次请求网关状态
			function getGatewayStatusAgain(){
				var reqUrl = poer_url.get_gateway_status(resultInetAddress);
                poer_function.get_gateway_status(reqUrl,{},getGatewayStatusSuccess,getGatewayStatusFailed);
			}
			
			//再次请求LinkAp状态
			function getLinkApStatusAgain(){
				var reqUrl = poer_url.link_ap_status();
				poer_function.link_ap_status(reqUrl, {}, checkApConnectStatusTwoSuccess, checkApConnectStatusTwoFailed);
			}
			
            /**
             * 获取用户信息成功
             * @param {Object} data
             */
            function getUserInfoSuccess(data) {
                if (isTimeout) return;
                setTimeout(function () {
                    checkGateway();
                }, 1500);
            }

            /**
             * 获取用户信息失败
             * @param {Object} xhr
             * @param {Object} textStatus
             * @param {Object} errorThrown
             */
            function getUserInfoFailed(xhr, textStatus, errorThrown) {
                if (isTimeout) return;
                stopConfigProgress();
                poer_public.alert(poer_language.label_link_wifi_failed(language));
                
            }

            var isChecking = false;

            function checkGateway() {
                if (isTimeout) return;
                if (!isChecking) {
                    isChecking = true;
                    var reqUrl = poer_url.check_gatewayV2(userId, locateId, gatewaySSID);
                    poer_function.check_gateway(reqUrl, {}, checkGatewaySuccess, checkGatewayFailed);
                }
            }

            /**
             * 验证网关成功
             * @param {Object} data
             */
            function checkGatewaySuccess(data) {
                if (isTimeout) return;
                console.log( "FUNC-checkGatewaySuccess" + JSON.stringify(data) );
                var flag = false;
                var str = null;
                switch(data.Status){
                		//绑定成功
                		case "10000":
                			isChecking = false;
	                    setTimeout(function () {
	                        var reqUrl = poer_url.gateway_info(userId, resultMacAddress.trim().toUpperCase());
	                        poer_function.get_gateway_info(reqUrl, {}, getGatewayInfoSuccess, getGatewayInfoFailed);
	                    }, 2000);
                			break;
                		//参数错误/网关不存在/当前网关离线 重试
                		case "E00009":
                		case "E00004":
                		case "E00005":
                			check_count++;
	                    if (check_count > 50) {
	                        stopConfigProgress();
	                        poer_public.alert(poer_language.label_bindgateway_failed(language), function () {
	                            isChecking = false;
	                        });
	                        check_count = 0;
	                    } else {
	                        isChecking = false;
	                        setTimeout(checkGateway, 2000);
	                    }
                			break;
                		//已经绑定网关到当前区域
                		case "E00013":
                			flag = true;
                			str = poer_language.msg_wifi_connection_success(language);
                			currentStep = 2;
                			break;
                		//已经绑定网关到其他区域
                		case "E00014":
                			check_count = 0;
                			stopConfigProgress();
	                    poer_public.alert(poer_language.ErrRelatedToOtherLocate(language), function () {
	                   		isChecking = false;
	                   		$.back();
	                    });
                			break;
                		//其他未知情况直接结束
                		default:
                			flag = true;
                        str = poer_language.ErrOther(language);
                			break;
                }
                if(flag){
                		stopConfigProgress();
                    poer_public.alert(str, function () {
                   		isChecking = false;
                        setStep();
                    });
                    check_count = 0;
                    flag = false;
                    str = null;
                }
            }

            /**
             * 验证网关失败
             * @param {Object} xhr
             * @param {Object} textStatus
             * @param {Object} errorThrown
             */
            function checkGatewayFailed(xhr, textStatus, errorThrown) {
                if (isTimeout) return;
                check_count++;
                if (check_count > 50) {
                    stopConfigProgress();
                    poer_public.alert(poer_language.label_bindgateway_failed(language), function () {
                        isChecking = false;
                    });
                    check_count = 0;
                } else {
                    isChecking = false;
                    setTimeout(checkGateway, 2000);
                }
            }

            /**
             * 获取网关信息成功
             * @param {Object} data
             */
            function getGatewayInfoSuccess(data) {
                if (isTimeout) return;
                var d = new Date();
                var offset = d.getTimezoneOffset();
                offset *= -1;
                var time_zones = poer_timezone.time_zone();
                var show_time;
                //转换成12:00格式
                show_time = parseInt(offset / 60) + ":";
                if (offset % 60 < 10) {
                    show_time += "0" + offset % 60;
                } else {
                    show_time += offset % 60;
                }
                show_time = offset < 0 ? "-" + show_time : "+" + show_time;
                var zone_city = '';
                for (var i in time_zones) {
                    if (time_zones[i] == show_time) {
                        zone_city = i;
                        break;
                    }
                }
                var gateway_id = data.Id;
                var reqUrl = poer_url.update_gateway(userId, gateway_id);
                var data = {
                    "DstEnable": data['DstEnable'],
                    "DstEnd": data['DstEnd'],
                    "DstOffset": data['DstOffset'],
                    "DstStart": data['DstStart'],
                    "ZoneOffset": offset,
                    "ZoneCity": zone_city
                };
                setTimeout(function () {
                    poer_function.update_gateway(reqUrl, JSON.stringify(data), updateGatewaySuccess, updateGatewayFailed);
                }, 2000);
            }

            /**
             * 获取网关信息失败
             * @param {Object} xhr
             * @param {Object} textStatus
             * @param {Object} errorThrown
             */
            function getGatewayInfoFailed(xhr, textStatus, errorThrown) {
                if (isTimeout) return;
                stopConfigProgress();
                poer_public.alert(poer_language.label_bindgateway_failed(language));
            }

            /**
             * 更新网关成功
             * @param {Object} data
             */
            function updateGatewaySuccess(data) {
                if (isTimeout) return;
                setTimeout(function () {
                    stopConfigProgress();
                    poer_public.alert(poer_language.msg_wifi_connection_success(language), function () {
                        stopConfigProgress();
                        currentStep = 2;
                        setStep();
                        poer_function.setLocalStorage("smart_config_times", 1);
                    }, poer_language.label_tip(language));
                }, 2000);
            }

            /**
             * 更新网关失败
             * @param {Object} xhr
             * @param {Object} textStatus
             * @param {Object} errorThrown
             */
            function updateGatewayFailed(xhr, textStatus, errorThrown) {
                if (isTimeout) return;
                stopConfigProgress();
                poer_public.alert(poer_language.label_bindgateway_failed(language));
            }

            function stopConfigProgress() {
//              clearTimer();
                closeConfigProgress();
            }

            function openConfigProgress() {
                isConfiguring = true;
//              setTimer();
                waitingToast = poer_public.showWaiting(poer_language.label_config_title_start(language));
            }

            function closeConfigProgress() {
                isConfiguring = false;
                waitingToast.close();
            }

            doc.getElementById("btnBack").addEventListener("tap", function () {
                if (!isConfiguring) $.back();
            });
			function errstatus(id){
				var buttons = poer_language.array_button_for_sc_config_fail(language);
				var msg;
				switch(id){
					case 1: 
						msg = poer_language.msg_errstatus_1(language);
						break;
					case 2:
//						alert("无法从路由器获取动态ip地址");
						msg = poer_language.msg_errstatus_2(language);
						break;
					case 4:
//						alert("无线网络配置错误，密码错误");
						msg = poer_language.msg_errstatus_4(language);
						break;
					case 6:
//						alert("dns解析失败");
						msg = poer_language.msg_errstatus_6(language);
						break;
					case 7:
//						alert("网关内部错误，请重新上电");
						msg = poer_language.msg_errstatus_7(language);
						break;
					default:
					    //未知错误
						msg = poer_language.msg_errstatus_default(language);
						break;
				}
                mui.confirm(msg, "", buttons, function (e) {
                    switch (e.index) {
                        case 0:
                        		apCount = 0;
                            break;
                        case 1:
                            currentStep = 0;
                            setStep();
                            getCurrentWifiInfo();
                            break;
                    }
                });
			}
			
            function setStep() {
                mui.each(mui(".step-content"), function (index, item) {
                    if (index == currentStep) {
                        item.style.removeProperty("display");
                    } else {
                        item.style.display = "node";
                    }
                })
                switch (currentStep) {
                    case 0:
//                    		doc.getElementById("step-content-1").style.display = "";
//                    		doc.getElementById("step-content-2").style.display = "none";
//                    		doc.getElementById("step-content-3").style.display = "none";
                        doc.getElementById("img-step-1").src = "../img/preparationg-on.png";
                        doc.getElementById("step-1").src = "../img/step-on.png";
                        doc.getElementById("name-step-1").innerHTML = poer_language.label_name_preparationg(language);
                        doc.getElementById("img-step-2").src = "../img/wifi-conn-off.png";
                        doc.getElementById("step-2").src = "../img/step-off.png";
                        doc.getElementById("name-step-2").innerHTML = "";
                        doc.getElementById("img-step-3").src = "../img/conn-check-off.png";
                        doc.getElementById("step-3").src = "../img/step-off.png";
                        doc.getElementById("name-step-3").innerHTML = "";
                        break;
                    case 1:
//                    		doc.getElementById("step-content-1").style.display = "none";
//                    		doc.getElementById("step-content-2").style.display = "";
//                    		doc.getElementById("step-content-3").style.display = "none";
                        doc.getElementById("img-step-1").src = "../img/preparationg-off.png";
                        doc.getElementById("step-1").src = "../img/step-off.png";
                        doc.getElementById("name-step-1").innerHTML = "";
                        doc.getElementById("img-step-2").src = "../img/wifi-conn-on.png";
                        doc.getElementById("step-2").src = "../img/step-on.png";
                        doc.getElementById("name-step-2").innerHTML = poer_language.label_name_wifi_connection(language);
                        doc.getElementById("img-step-3").src = "../img/conn-check-off.png";
                        doc.getElementById("step-3").src = "../img/step-off.png";
                        doc.getElementById("name-step-3").innerHTML = "";
                        break;
                    case 2:
//                    		doc.getElementById("step-content-1").style.display = "none";
//                    		doc.getElementById("step-content-2").style.display = "none";
//                    		doc.getElementById("step-content-3").style.display = "";
                        doc.getElementById("img-step-1").src = "../img/preparationg-off.png";
                        doc.getElementById("step-1").src = "../img/step-off.png";
                        doc.getElementById("name-step-1").innerHTML = "";
                        doc.getElementById("img-step-2").src = "../img/wifi-conn-off.png";
                        doc.getElementById("step-2").src = "../img/step-off.png";
                        doc.getElementById("name-step-2").innerHTML = "";
                        doc.getElementById("img-step-3").src = "../img/conn-check-on.png";
                        doc.getElementById("step-3").src = "../img/step-on.png";
                        doc.getElementById("name-step-3").innerHTML = poer_language.label_name_connection_check(language);
                        break;
                }
            }

        });
    }(mui, document));
</script>
</body>

</html>